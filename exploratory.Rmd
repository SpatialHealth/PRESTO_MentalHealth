---
title: "exploratory"
author: "Cam Reimer"
date: "2023-09-26"
output: html_document
---

```{r, INIT}
#load in packages 
library(tidyverse)
library(lubridate)
library(dplyr)
library(corrplot)

#load in data
load("C:/Users/camer/OneDrive/Documents/SPH/PRESTO/data/data_processed.RData")
load("C:/Users/camer/OneDrive/Documents/SPH/PRESTO/data/dropped.RData")
```

```{r, DEMOGRAPHIC}
# States and Provinces
all <- sort(unique(data$state))
provinces <- c('AB', 'BC', 'MB', 'NB', 'NL', 'NT', 'NS', 'NU', 'ON', 'PE', 'QC', 'SK', 'YT')

CAD <- provinces[provinces %in% all]
CAD # All provinces and 2 territories (not Nunavut)
length(CAD)

USA <- all[!(all %in% provinces)]
USA #All states + DC, except for AK and HI
length(USA)

counts <- data |> select(Country, state) |> count(state, Country)
write.csv(counts, "C:/Users/camer/OneDrive/Documents/SPH/PRESTO/map_counts.csv")

### Income 
#% of participants with income >$50,000
(sum(as.numeric(data$b_income) >= 4) / nrow(data)) * 100

#% w/ income >$50,000 for dropped participants
(sum(as.numeric(dropped$b_income) >= 4, na.rm = TRUE) / length(na.omit(dropped$b_income))) * 100
```

```{r, NDVI CORRELATIONS}
# Get NDVI columns
all_n <- dplyr::select(data, matches('ndvi', ignore.case = 'quantile')) |>
    dplyr::select(!matches('quantile'))
n <- dplyr::select(all_n, !matches('iqr'))
iqr <- dplyr::select(all_n, matches('iqr'))

# Rename columns
cnames <- paste0( c(rep('Annual max', 4), rep('Sesonal max', 4), rep('Sesonal mean', 4)), ' ', rep(c('50m', '100m', '250m', '500m'), 3))
colnames(n) <- cnames
colnames(iqr) <- cnames

dat <- n
m <- round(cor(dat, method = "spearman"), 2)

write.csv(m,"C:/Users/camer/OneDrive/Documents/SPH/PRESTO/supplementary/NDVIcorrelations.csv" )
```

```{r}
# Estimates and CI for select models 
source("analysis_functions.R")
x <- c("ageatqstn", "b_race_ethnic_census", "b_educ", "b_income", "b_totalmet", "ct_HHinc", "ct_lths")

# Full sample - PSS model 1 
ma <- lmfull_processed(data = data, y = 'pss_score', buffers = 100, x = x[1:2], ndvi_measure = 'amax', sig_figs = 2)
ma

mb <- lmfull_processed(data = data, y = 'pss_score', buffers = 100, x = x, ndvi_measure = 'amax', sig_figs = 2)
mb

x <- c("ageatqstn", "b_race_ethnic_census", "b_educ", "b_income", "b_totalmet", "ct_lths") 

# NSES1 - urban
m1 <- lmfull_processed(data = NSES1_urban, y = 'pss_score', buffers = 100, x = x, ndvi_measure = 'amax', sig_figs = 2 )
m1

# NSES2 - urban 
m2 <- lmfull_processed(data = NSES2_urban, y = 'pss_score', buffers = 100, x = x, ndvi_measure = 'amax', sig_figs = 2 )
m2

# NSES3 - rural
m3 <- lmfull_processed(data = NSES3_rural, y = 'pss_score', buffers = 500, x = x, ndvi_measure = 'amax', sig_figs = 2 )
m3

```

```{r}
### REPEAT w/ MDI 
# Full sample - model 1 
x <- c("ageatqstn", "b_race_ethnic_census", "b_educ", "b_income", "b_totalmet", "ct_HHinc", "ct_lths")

ma <- lmfull_processed(data = data, y = 'b_mdi_score', buffers = 100, x = x[1:2], ndvi_measure = 'amax', sig_figs = 2)
ma

mb <- lmfull_processed(data = data, y = 'b_mdi_score', buffers = 100, x = x, ndvi_measure = 'amax', sig_figs = 2)
mb

x <- c("ageatqstn", "b_race_ethnic_census", "b_educ", "b_income",  "b_totalmet", "ct_lths") 

# NSES1 - urban
m1 <- lmfull_processed(data = NSES1_urban, y = 'b_mdi_score', buffers = 100, x = x, ndvi_measure = 'amax', sig_figs = 2 )
m1

# NSES2 - urban 
m2 <- lmfull_processed(data = NSES2_urban, y = 'b_mdi_score', buffers = 100, x = x, ndvi_measure = 'amax', sig_figs = 2 )
m2

# NSES3 - rural
m3 <- lmfull_processed(data = NSES3_rural, y = 'b_mdi_score', buffers = 500, x = x, ndvi_measure = 'amax', sig_figs = 2 )
m3
```