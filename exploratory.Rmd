---
title: "exploratory"
author: "Cam Reimer"
date: "2023-09-26"
output: html_document
---

```{r, INIT}
#load in packages 
library(tidyverse)
library(lubridate)
library(dplyr)
library(corrplot)
library(RColorBrewer)
#load in data
load("C:/Users/camer/OneDrive/Documents/SPH/PRESTO/data/data_processed.RData")
load("C:/Users/camer/OneDrive/Documents/SPH/PRESTO/data/dropped.RData")
```

```{r, DEMOGRAPHIC}
# States and Provinces
all <- sort(unique(data$state))
provinces <- c('AB', 'BC', 'MB', 'NB', 'NL', 'NT', 'NS', 'NU', 'ON', 'PE', 'QC', 'SK', 'YT')

CAD <- provinces[provinces %in% all]
CAD # All provinces and 2 territories (not Nunavut)
length(CAD)

USA <- all[!(all %in% provinces)]
USA #All states + DC, except for AK and HI
length(USA)


### Income 
#% of participants with income >$50,000
(sum(as.numeric(data$b_income) >= 4) / nrow(data)) * 100

#% w/ income >$50,000 for dropped participants
(sum(as.numeric(dropped$b_income) >= 4, na.rm = TRUE) / length(na.omit(dropped$b_income))) * 100
```

```{r, NDVI CORRELATIONS}
# Get NDVI columns
all_n <- dplyr::select(data, matches('ndvi', ignore.case = 'quantile')) |>
    dplyr::select(!matches('quantile'))
n <- dplyr::select(all_n, !matches('iqr'))
iqr <- dplyr::select(all_n, matches('iqr'))

# Rename columns
cnames <- paste0( c(rep('Annual max', 4), rep('Sesonal max', 4), rep('Sesonal mean', 4)), ' ', rep(c('50m', '100m', '250m', '500m'), 3))
#cnames <- rep(c("50m", "100m", "250m", "500m"),4)
colnames(n) <- cnames
colnames(iqr) <- cnames

dat <- n
m <- round(cor(dat, method = "spearman"), 2)
#m <- round(cor(dat, method = "pearson"), 2)

cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
# matrix of the p-value of the correlation
p.mat <- cor.mtest(m)

#col <- colorRampPalette(c("#BB4444", "#EE9988",  "#FFFFFF", "#166628"))
#col <- colorRampPalette(c("#BB4444", '#ee1b1b', '#f68d8d', "#FFFFFF", "#166628"))
col <- colorRampPalette(c('#850a0a', '#c90f0f', '#f03232', '#fabbbb', '#ffffff',  "#166628"))

```

```{r, export correlation plot }
png("C:/Users/camer/OneDrive/Documents/SPH/PRESTO/supplementary/corrplot_V2_spearman.png", width = 800, height = 800)
corrplot(m, method="color", 
         #col=brewer.pal(n=11, name="PiYG"), 
         col = col(200),
         type="upper", 
         #order="hclust", 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         # Combine with significance
         p.mat = p.mat, sig.level = 0.1, insig = 'blank', 
         # hide correlation coefficient on the principal diagonal
         diag=FALSE 
         )
dev.off()

write.csv(m,"C:/Users/camer/OneDrive/Documents/SPH/PRESTO/supplementary/NDVIcorrelations.csv" )
```

```{r}
# Estimates and CI for select models 
source("analysis_functions.R")
x <- c("ageatqstn", "b_race_ethnic_census", "b_educ", "b_income", "b_totalmet", "ct_HHinc", "ct_lths")

# Full sample - PSS model 1 
ma <- lmfull_processed(data = data, y = 'pss_score', buffers = 100, x = x[1:2], ndvi_measure = 'amax', sig_figs = 2)
ma

mb <- lmfull_processed(data = data, y = 'pss_score', buffers = 100, x = x, ndvi_measure = 'amax', sig_figs = 2)
mb

x <- c("ageatqstn", "b_race_ethnic_census", "b_educ", "b_income", "b_totalmet", "ct_lths") 

# NSES1 - urban
m1 <- lmfull_processed(data = NSES1_urban, y = 'pss_score', buffers = 100, x = x, ndvi_measure = 'amax', sig_figs = 2 )
m1

# NSES2 - urban 
m2 <- lmfull_processed(data = NSES2_urban, y = 'pss_score', buffers = 100, x = x, ndvi_measure = 'amax', sig_figs = 2 )
m2

# NSES3 - rural
m3 <- lmfull_processed(data = NSES3_rural, y = 'pss_score', buffers = 500, x = x, ndvi_measure = 'amax', sig_figs = 2 )
m3

```

```{r}
### REPEAT w/ MDI 
# Full sample - model 1 
x <- c("ageatqstn", "b_race_ethnic_census", "b_educ", "b_income", "b_totalmet", "ct_HHinc", "ct_lths")

ma <- lmfull_processed(data = data, y = 'b_mdi_score', buffers = 100, x = x[1:2], ndvi_measure = 'amax', sig_figs = 2)
ma

mb <- lmfull_processed(data = data, y = 'b_mdi_score', buffers = 100, x = x, ndvi_measure = 'amax', sig_figs = 2)
mb

x <- c("ageatqstn", "b_race_ethnic_census", "b_educ", "b_income",  "b_totalmet", "ct_lths") 

# NSES1 - urban
m1 <- lmfull_processed(data = NSES1_urban, y = 'b_mdi_score', buffers = 100, x = x, ndvi_measure = 'amax', sig_figs = 2 )
m1

# NSES2 - urban 
m2 <- lmfull_processed(data = NSES2_urban, y = 'b_mdi_score', buffers = 100, x = x, ndvi_measure = 'amax', sig_figs = 2 )
m2

# NSES3 - rural
m3 <- lmfull_processed(data = NSES3_rural, y = 'b_mdi_score', buffers = 500, x = x, ndvi_measure = 'amax', sig_figs = 2 )
m3
```